---
- name: install dependencies
  become: yes
  apt:
    name: '{{ item }}'
    state: present
  with_items:
    - python-pip
    - libssl-dev

# Query available Molecule versions and split one per line
- name: query available molecule versions
  shell: "pip install molecule== &> >(sed -r 's/[^0-9\\.]*([0-9dev\\.]*)[^0-9\\.]*/\\1\\n/g' | sed '/^$/d') || $(exit 0)"
  args:
    executable: /bin/bash
  register: available_molecule_versions
  check_mode: no
  changed_when: no

- name: assert molecule version available
  assert:
    that:
      - 'molecule_version in available_molecule_versions.stdout_lines'

- name: add ansible ppa
  become: yes
  apt_repository:
    repo: 'ppa:ansible/ansible'
    state: present

- name: install ansible
  become: yes
  apt:
    name: ansible
    state: present

- name: create download directory
  file:
    path: '{{ molecule_download_dir }}'
    state: directory

# Need to update `wheel` or ansible-lint will get installed without the
# execute bit set (https://bitbucket.org/pypa/wheel/issues/154).
- name: install wheel
  become: yes
  pip:
    name: wheel
    state: present
    extra_args: '--upgrade'

- name: install python docker library
  become: yes
  pip:
    name: docker
    # 2018-04-16
    # Limit version as workaround for: https://github.com/ansible/ansible/issues/35612
    version: '2.7.0'
    state: present

- name: downgrade pip (pip 10 workaround)
  become: yes
  pip:
    name: pip
    # Workaround pip 10 issue (see https://github.com/pypa/pip/issues/4805)
    version: '9.0.3'
    state: present

- name: install molecule
  become: yes
  pip:
    name: molecule
    version: '{{ molecule_version }}'
    state: present
